@page "/admin/place"


@using FamTec.Client.Pages.Admin.Place.PlaceMain.Modal
@using FamTec.Shared.Client.DTO
@using FamTec.Shared.Server
@using Newtonsoft.Json
@using System.Reflection
@using System.ComponentModel.DataAnnotations
@using FamTec.Client.Pages.Admin.CommonComponents
@inject HttpClient HttpClient

<div class="place-container">
        <div class="place-header">
            <span class="place-title">
                사업장 목록
            </span>
            <div class="table-header-option">
            <Input Placeholder="search" ValueChanged="OnSearchTextChanged" />
                <Button 
                    Name="등록"
                    Width="true"
                    OnClick="@onAddPlace" />
            <Button Name="삭제"
                    Width="true"
                    Type="true"
                    />
            </div>
        </div>
        <div class="place-table">
            <Table 
                DataList="FilterPlaceList"
                Detail="true"
                />
        </div>
        @if (is_openModal)
        {
            <AddModal Title="사업장 등록" OnClose="@OnModalClose" />
        }
    
 
</div>

@code {
     /*
     * 테이블 데이터
    */
    List<PlaceDTO> PlaceList;
    List<string> PlaceProperties = new List<string>();
    List<PlaceDTO> SelecList = new List<PlaceDTO>();
    List<PlaceDTO> FilterPlaceList = new List<PlaceDTO>();

    string searchText = string.Empty;


    // public HttpClient httpClient = new HttpClient();

    bool is_openModal = false;

    protected override async Task OnInitializedAsync()
    {

        /*
        * fetch 서버 요청
        */
        Console.WriteLine("매니저 조회 시작");
        ResponseObj<PlaceDTO> res = await HttpClient.GetFromJsonAsync<ResponseObj<PlaceDTO>>("http://127.0.0.1:5245/api/AdminPlace/GetAllWorksList");
        PlaceList = res.data;
        FilterPlaceList = PlaceList;
        Console.WriteLine(PlaceList.Count);

        var properties = typeof(PlaceDTO).GetProperties();

        foreach(var property in properties)
        {
            var displayAttribute = property.GetCustomAttribute<DisplayAttribute>();
            if(displayAttribute != null)
            {
                string displayName = displayAttribute.Name;
                PlaceProperties.Add(displayName);
            }
        }
    }

     /*
     * 검색 데이터 필터링
    */
    private void OnSearchTextChanged(string text)
    {
        // searchText = e.Value.ToString();
        searchText = text;
        FilterPlaceList = string.IsNullOrEmpty(searchText)
            ? PlaceList
            : PlaceList.Where(p => p.Name.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                                   p.PlaceCd.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                                   p.ContractNum.Contains(searchText, StringComparison.OrdinalIgnoreCase))
                        .ToList();
    }

    /*
     * 체크
    * Add to List<PlaceDTO>SelectList when able Checkbox
    */
    public void OnSelected(object row)
    {
        /*
        * To Do
        * 동일 row 중복 처리
        */
        Console.WriteLine(row);

        if (row is PlaceDTO palceRow)
        {
            if (!SelecList.Contains(row))
            {
                Console.WriteLine("추가");
                SelecList.Add(palceRow);
            }

        }



        Console.WriteLine(SelecList);
    }

    /*
     * 체크 해제
     * Remove to List<PlaceDTO>SelectList when disable Checkbox
    */
    public void UnSelected(object row)
    {
        if (row is PlaceDTO palceRow)
        {
            Console.WriteLine("삭제 전");
            foreach (PlaceDTO a in SelecList)
            {

                Console.WriteLine(a.PlaceCd);
            }
            SelecList.Remove(palceRow);
            Console.WriteLine("삭제 후");
            foreach (PlaceDTO a in SelecList)
            {

                Console.WriteLine(a.PlaceCd);
            }
        }
    }

    /*
    * click add
    */
    private void onAddPlace()
    {
        is_openModal = true;
    }

    /*
     * 모달 활성화
     */
    private void OnModalClose()
    {
        is_openModal = false;
        StateHasChanged();
    }
}
